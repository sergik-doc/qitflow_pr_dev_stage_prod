name: Create Change Log After Release

on:
  release:
    types: [published]

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Get Previous Tag
        id: prev_tag
        run: echo "::set-output name=TAG::$(git describe --tags $(git rev-list --tags --max-count=1)^)"

      - name: Get Commit Log
        id: commit_log
        run: |
          PREV_TAG=${{ steps.prev_tag.outputs.TAG }}
          if [ -z "$PREV_TAG" ]; then
            echo "::set-output name=LOG::$(git log --pretty=format:'%h - %s' ${{ github.sha }} --not --remotes)"
          else
            echo "::set-output name=LOG::$(git log --pretty=format:'%h - %s' $PREV_TAG..${{ github.sha }})"
          fi

      - name: Create Change Log
        run: |
          echo "## Change Log for Release ${{ github.event.release.tag_name }}" > change.log
          echo "${{ steps.commit_log.outputs.LOG }}" >> change.log

      - name: Commit Change Log
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add change.log
          git commit -m "Add change log for release ${{ github.event.release.tag_name }}"
          git push origin main
